## ORM
object-relational mapping
**자바의 객체와 데이터베이스를 연결하는 프로그래밍 기법.**

SQL을 전혀 몰라도 자바 언어로만 데이터베이스에 접근해서 원하는 데이터를 받아올 수 있다.
즉, **객체와 데이터베이스를 연결해 자바 언어로만 데이터베이스를 다룰 수 있게 하는 도구.**
=> 객체 지향적 코드 작성이 가능하여 비즈니스 로직에만 집중 가능.


### JPA
java persistence API
ORM의 한 종류로 자바에서 표준으로 사용.
**자바에서 관계형 데이터베이스를 사용하는 방식을 정의한 인터페이스.**

인터페이스이므로, 실제 사용을 위해서는 ORM 프레임워크를 추가로 선택해야 한다.
대표적으로 하이버네이트(hibernate).
	내부적으로 JDBC API 사용.
	=> 자바 객체를 통해 데이터베이스 종류에 상관없이 데이터베이스를 자유자재로 사용할 수 있게 함.
![[Pasted image 20241113000613.png]]


##### 개념
1. [[entity manager]]
2. [[persistence context]]


##### Spring data
비즈니스 로직에 더 집중할 수 있게 데이터베이스 사용 기능을 클래스 레벨에서 추상화.

#### Spring data JPA
spring data의 공통적인 기능에서 JPA의 유용한 기술이 추가된 기술.
기존에는 메서드 호출로 entity의 상태를 바꿨다면, **spring data JPA에서는 repository 역할을 하는 인터페이스를 만들어 테이블 조회, 수정, 생성, 삭제 같은 작업을 간단히 할 수 있다.**
```java
pulbic interface MemberRepository extends JpaRepository<Member, Lon> {
}
```
위와 같이 JpaRepository 인터페이스를 MemberRepository 인터페이스에서 상속 받고, 제너릭에는 관리할 <entity name, entity PK의 type>을 입력하면 기본 CRUD 메서드를 사용할 수 있다.

```java
package me.hyunsoyoung.springbootdeveloper;  
  
import static org.assertj.core.api.AssertionsForClassTypes.assertThat;  
  
import java.util.List;  
import org.junit.jupiter.api.Test;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;  
import org.springframework.test.context.jdbc.Sql;  
  
@DataJpaTest  
class MemberRepositoryTest {  
    @Autowired  
     MemberRepository memberRepository;  

	// 테스트를 실행하기 전에 sql 스크립트 실행
    @Sql("/insert-members.sql")  
    @Test  
    void getAllMembers(){  
        // when  
        List<Member> members = memberRepository.findAll();  
  
        // then  
        assertThat(members.size()).isEqualTo(3);  
    }  
  
}
```


##### 예제 코드
Member.java
```java
package me.hyunsoyoung.springbootdeveloper;  
  
import jakarta.persistence.*;  
import lombok.AccessLevel;  
import lombok.AllArgsConstructor;  
import lombok.Getter;  
import lombok.NoArgsConstructor;  
  
@NoArgsConstructor(access = AccessLevel.PROTECTED) // 기본 생성자.  
@AllArgsConstructor  
@Getter  
@Entity  // entity로 지정. 
// 테이블 이름을 지정하지 않았으므로 클래스 이름과 같은 member 테이블과 매핑된다. // 테이블을 매핑하고 싶으면 파라미터로 넣어주면 된다.  
// @Entity(name = "member_list") => name 파라미터로 클래스와 member_list 테이블 매핑

public class Member {  
    @Id  // id 필드를 기본키로 지정.  
    @GeneratedValue(strategy = GenerationType.IDENTITY)   // 기본키를 자동으로 1씩 증가  
    @Column(name = "id", updatable = false)  
    private Long id; //DB 테이블의 id컬럼과 매칭  
  
    @Column(name = "name", nullable = false)  // name이라는 not null column과 매칭  
    private String name; //DB 테이블의 name컬럼과 매칭  
  
    public void changeName(String name) {  
        this.name = name;  // name의 필드 값 변경.  
    }  
}
```

##### test 코드
```java
package me.hyunsoyoung.springbootdeveloper;  
  
import static org.assertj.core.api.AssertionsForClassTypes.assertThat;  
  
import java.util.List;  
import org.junit.jupiter.api.AfterEach;  
import org.junit.jupiter.api.Test;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;  
import org.springframework.test.context.jdbc.Sql;  
  
@DataJpaTest  
class MemberRepositoryTest {  
    @Autowired  
     MemberRepository memberRepository;  
  
    @Sql("/insert-members.sql")  
    @Test  
    void getAllMembers(){  
        // when  
        List<Member> members = memberRepository.findAll();  
  
        // then  
        assertThat(members.size()).isEqualTo(3);  
    }  
  
    @Sql("/insert-members.sql")  
    @Test  
    void getMemberById(){  
        // when  
        Member member = memberRepository.findById(2L).get();  
  
        // then  
        assertThat(member.getName()).isEqualTo("B");  
    }  
  
    @Sql("/insert-members.sql")  
    @Test  
    void getMemberByName(){  
        // when  
        Member member = memberRepository.findByName("C").get();  
  
        // then  
        assertThat(member.getId()).isEqualTo(3);  
    }  
  
    @Test  
    void saveMembers(){  
        // given  
        List<Member> members = List.of(new Member(2L, "B"), new Member(3L, "C"));  
  
        // when  
        memberRepository.saveAll(members);  
  
        //then  
        assertThat(memberRepository.findAll().size()).isEqualTo(2);  
    }  
  
    @Sql("/insert-members.sql")  
    @Test  
    void deleteMemberById(){  
        // when  
        memberRepository.deleteById(2L);  
  
        // then  
        assertThat(memberRepository.findById(2L).isEmpty()).isTrue();  
    }  
  
    @Sql("/insert-members.sql")  
    @Test  
    void deleteAll() {  
        // when  
        memberRepository.deleteAll();  
  
        // then  
        assertThat(memberRepository.findAll().size()).isZero();  
    }  
  
    // 한 테스트의 실행으로 데이터베이스가 변경되었을 때,  
    // 다른 테스트가 그 데이터베이스를 사용할 때 영향을 주지 않도록 하기 위함.  
    @AfterEach  
    public void cleanUp(){  
        memberRepository.deleteAll();  
    }  
  
    @Sql("/insert-members.sql")  
    @Test  
    void update() {  
        // given  
        Member member = memberRepository.findById(2L).get();  
  
        // when  
        member.changeName("BC");  
  
        // then  
        assertThat(memberRepository.findById(2L).get().getName()).isEqualTo("BC");  
    }  
}
```

##### MemberRepository.java
```java
@Repository  
public interface MemberRepository extends JpaRepository<Member, Long> {  
    Optional<Member> findByName(String name);  
  
}
```
[[repository]]는 entity에 있는 데이터들을 조회하거나 저장, 변경, 삭제 할 때 사용하는 인터페이스.
스프링 데이터 JPA에서 제공하는 인터페이스인 JpaRepository 클래스를 상속받아 간단하게 구현할 수 있다.
JpaRepository 클래스를 상속받을 때, 엔티티 Member와 엔티티의 기본키 타입 Long을 인수로 넣어준다. 
이제 해당 repository를 사용할 때, JpaRepository에서 제공하는 여러 메서드를 사용할 수 있게 된다.

![[Pasted image 20241113021654.png]]
